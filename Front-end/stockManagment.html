<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">
    <!-- Loading Screen -->
    <div id="loading" class="text-center py-6">Loading...</div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <div class="container mx-auto p-6">
            <h1 class="text-4xl font-bold text-center text-blue-600 mb-8">Stock Management</h1>

            <!-- Create Stock Form -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Add New Stock</h2>
                <form id="createStockForm" class="grid grid-cols-1 gap-4">
                    <input type="text" id="stockName" placeholder="Stock Name" class="p-3 border border-gray-300 rounded bg-gray-50 text-gray-800 placeholder-gray-500">
                    <input type="number" id="stockQuantity" placeholder="Quantity" class="p-3 border border-gray-300 rounded bg-gray-50 text-gray-800 placeholder-gray-500">
                    <input type="number" step="0.01" id="stockPrice" placeholder="Price" class="p-3 border border-gray-300 rounded bg-gray-50 text-gray-800 placeholder-gray-500">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">Create</button>
                </form>
            </div>

            <!-- Stock Table -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Stocks</h2>
                <table class="table-auto w-full border-collapse border border-gray-300">
                    <thead>
                        <tr>
                            <th class="border border-gray-300 px-4 py-2 text-left text-gray-600">Name</th>
                            <th class="border border-gray-300 px-4 py-2 text-left text-gray-600">Quantity</th>
                            <th class="border border-gray-300 px-4 py-2 text-left text-gray-600">Price</th>
                            <th class="border border-gray-300 px-4 py-2 text-left text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        <!-- Stock rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-lg w-1/3">
            <h3 class="text-lg font-semibold mb-4">Edit Stock</h3>
            <input type="text" id="editName" placeholder="Name" class="mb-2 p-2 w-full border rounded">
            <input type="number" id="editQuantity" placeholder="Quantity" class="mb-2 p-2 w-full border rounded">
            <input type="number" id="editPrice" placeholder="Price" class="mb-2 p-2 w-full border rounded">
            <div class="flex justify-end gap-2">
                <button onclick="saveEdit()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
                <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const stockTableBody = document.getElementById('stockTableBody');
        const createStockForm = document.getElementById('createStockForm');
        const editModal = document.getElementById('editModal');
        let currentEditIndex = -1;

        // Mock data store
        let stocks = [];

        // Function to render stocks in the table
        function renderStocks() {
            stockTableBody.innerHTML = '';
            stocks.forEach((stock, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">${stock.name}</td>
                    <td class="border border-gray-300 px-4 py-2">${stock.quantity}</td>
                    <td class="border border-gray-300 px-4 py-2">${stock.price}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <button onclick="editStock(${index})" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">Edit</button>
                        <button onclick="deleteStock(${index})" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">Delete</button>
                    </td>
                `;
                stockTableBody.appendChild(row);
            });
        }

        // Function to create stock
        createStockForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('stockName').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            const price = parseFloat(document.getElementById('stockPrice').value);

            if (name && quantity >= 0 && price >= 0) {
                stocks.push({ name, quantity, price });
                renderStocks();
                createStockForm.reset();
            } else {
                alert('Please enter valid stock details.');
            }
        });

        // Function to edit stock
        function editStock(index) {
            currentEditIndex = index;
            const stock = stocks[index];
            document.getElementById('editName').value = stock.name;
            document.getElementById('editQuantity').value = stock.quantity;
            document.getElementById('editPrice').value = stock.price;
            editModal.classList.remove('hidden');
        }

        function saveEdit() {
            const name = document.getElementById('editName').value;
            const quantity = parseInt(document.getElementById('editQuantity').value);
            const price = parseFloat(document.getElementById('editPrice').value);

            if (name && quantity >= 0 && price >= 0) {
                stocks[currentEditIndex] = { name, quantity, price };
                renderStocks();
                closeModal();
            } else {
                alert('Please enter valid stock details.');
            }
        }

        function closeModal() {
            editModal.classList.add('hidden');
        }

        // Function to delete stock
        function deleteStock(index) {
            if (confirm('Are you sure you want to delete this stock?')) {
                stocks.splice(index, 1);
                renderStocks();
            }
        }

        // Authorization for manager
        window.addEventListener('load', async function () {
            try {
                const token = localStorage.getItem("jwtToken");
                if (!token) {
                    alert('You need to log in first.');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch('https://localhost:7020/Manager/managerDashboard', {
                    method: 'GET',
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    document.getElementById('mainContent').classList.remove('hidden');
                    document.getElementById('loading').classList.add('hidden');
                } else {
                    alert('Authorization failed, redirecting to home page.');
                    window.location.href = 'access-denied.html';
                }
            } catch (error) {
                console.error('Authorization error:', error);
                alert('An error occurred during authorization. Please try again.');
                document.getElementById('loading').classList.add('hidden');
                window.location.href = 'index.html';
            }
        });

        // Initial render
        renderStocks();
    </script>
</body>
</html>
